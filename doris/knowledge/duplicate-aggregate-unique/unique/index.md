[返回](/doris/knowledge/duplicate-aggregate-unique/index)


# Doris数据库Unique模型介绍

Unique模型是Apache Doris中的一种数据模型，它通过主键唯一性约束来保证数据的唯一性，适用于需要实时更新数据的场景。

## Unique模型特点

1. **唯一性约束**：通过主键保证数据的唯一性
2. **实时更新**：支持数据的实时更新操作
3. **删除支持**：支持按主键删除数据
4. **合并策略**：相同主键的数据会自动合并，保留最新版本

## 创建Unique模型的表

```sql
CREATE TABLE IF NOT EXISTS example_db.users_unique (
    user_id BIGINT,
    username VARCHAR(50),
    age INT,
    city VARCHAR(50),
    last_login DATETIME
)
UNIQUE KEY(user_id)
DISTRIBUTED BY HASH(user_id) BUCKETS 10
PROPERTIES (
    "replication_num" = "3",
    "enable_persistent_index" = "true"
);
```

## 数据操作示例

### 1. 插入数据

```sql
INSERT INTO example_db.users_unique 
VALUES 
    (1, '张三', 25, '北京', '2023-01-01 10:00:00'),
    (2, '李四', 30, '上海', '2023-01-02 11:00:00'),
    (3, '王五', 28, '广州', '2023-01-03 12:00:00');
```

插入后查询结果：
```
+---------+----------+------+--------+---------------------+
| user_id | username | age  | city   | last_login          |
+---------+----------+------+--------+---------------------+
|       1 | 张三     |   25 | 北京   | 2023-01-01 10:00:00 |
|       2 | 李四     |   30 | 上海   | 2023-01-02 11:00:00 |
|       3 | 王五     |   28 | 广州   | 2023-01-03 12:00:00 |
+---------+----------+------+--------+---------------------+
```

### 2. 更新数据（通过插入相同主键实现）

```sql
INSERT INTO example_db.users_unique 
VALUES 
    (1, '张三', 26, '北京', '2023-02-01 14:00:00'),
    (2, '李四', 31, '上海', '2023-02-02 15:00:00');
```

更新后查询结果：
```
+---------+----------+------+--------+---------------------+
| user_id | username | age  | city   | last_login          |
+---------+----------+------+--------+---------------------+
|       1 | 张三     |   26 | 北京   | 2023-02-01 14:00:00 |
|       2 | 李四     |   31 | 上海   | 2023-02-02 15:00:00 |
|       3 | 王五     |   28 | 广州   | 2023-01-03 12:00:00 |
+---------+----------+------+--------+---------------------+
```

### 3. 删除数据

```sql
DELETE FROM example_db.users_unique WHERE user_id = 3;
```

删除后查询结果：
```
+---------+----------+------+--------+---------------------+
| user_id | username | age  | city   | last_login          |
+---------+----------+------+--------+---------------------+
|       1 | 张三     |   26 | 北京   | 2023-02-01 14:00:00 |
|       2 | 李四     |   31 | 上海   | 2023-02-02 15:00:00 |
+---------+----------+------+--------+---------------------+
```

## Unique模型与Aggregate模型对比

```
+----------------------+----------------------+----------------------+
|        特性          |     Unique模型       |    Aggregate模型     |
+----------------------+----------------------+----------------------+
| 主键唯一性           | 支持                 | 支持                 |
| 数据更新方式         | 整行替换             | 按聚合函数更新       |
| 适用场景             | 需要实时更新的维度表 | 需要预聚合的指标表   |
| 存储开销             | 较高                 | 较低                 |
| 查询性能             | 点查快               | 聚合查询快           |
| 是否支持删除         | 支持                 | 不支持               |
+----------------------+----------------------+----------------------+
```

## Unique模型适用场景

1. **用户画像系统**：需要频繁更新用户属性
2. **商品信息管理**：商品信息变更频繁
3. **实时配置系统**：需要实时更新配置项
4. **账户管理系统**：账户信息需要实时更新

## 高级特性

### 部分列更新

```sql
-- 只更新用户的年龄和最后登录时间
INSERT INTO example_db.users_unique (user_id, age, last_login)
VALUES (1, 27, '2023-03-01 16:00:00');
```

更新后查询结果：
```
+---------+----------+------+--------+---------------------+
| user_id | username | age  | city   | last_login          |
+---------+----------+------+--------+---------------------+
|       1 | 张三     |   27 | 北京   | 2023-03-01 16:00:00 |
|       2 | 李四     |   31 | 上海   | 2023-02-02 15:00:00 |
+---------+----------+------+--------+---------------------+
```

### 条件更新

```sql
-- 只有当用户年龄小于30时才更新
INSERT INTO example_db.users_unique 
VALUES (1, '张三', 28, '北京', '2023-04-01 17:00:00')
ON DUPLICATE KEY UPDATE 
    age = IF(age < 30, VALUES(age), age),
    last_login = VALUES(last_login);
```

Unique模型通过主键唯一性保证了数据的准确性，同时提供了灵活的更新方式，非常适合需要实时更新数据的业务场景。