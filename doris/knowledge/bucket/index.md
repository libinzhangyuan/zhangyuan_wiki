[返回](/doris/knowledge/index)


# Apache Doris 分桶(Bucket)机制详解

分桶是Apache Doris中数据分布的物理划分方式，是数据水平划分的单位。下面我将详细介绍Doris的分桶机制。

## 1. 分桶基本概念

分桶是将表或分区数据按照分桶键(Bucket Key)的哈希值分散到不同节点上的机制。每个分桶实际是一个Tablet(数据分片)，是Doris中数据均衡和恢复的最小单位。

## 2. 分桶的优势

- **并行计算**：查询可以并行在所有分桶上执行
- **数据均衡**：数据均匀分布在各个节点
- **高效查询**：精确匹配分桶键的查询可以只扫描特定分桶
- **弹性扩展**：可以通过增加分桶数来提高并行度

## 3. 分桶键选择原则

- 选择经常作为查询条件的列
- 选择高基数的列(不同值多的列)
- 选择能避免数据倾斜的列
- 通常选择3-5个列作为分桶键

## 4. 分桶数量设置
```
分桶数量建议：
- 每个Tablet数据量建议在1GB-10GB之间
- 分桶数最好是BE节点数的整数倍
- 小表(几十GB)：设置4-8个分桶
- 中表(几百GB)：设置8-32个分桶
- 大表(TB级以上)：设置32-128个分桶
```
## 5. 分桶示例

### 创建表时指定分桶

```sql
CREATE TABLE example_db.user_behavior (
    user_id LARGEINT NOT NULL,
    item_id LARGEINT NOT NULL,
    category_id LARGEINT NOT NULL,
    behavior_type VARCHAR(20),
    ts DATETIME
)
DUPLICATE KEY(user_id, item_id, category_id)
PARTITION BY RANGE(ts) (
    PARTITION p202301 VALUES LESS THAN ('2023-02-01'),
    PARTITION p202302 VALUES LESS THAN ('2023-03-01')
)
DISTRIBUTED BY HASH(user_id, item_id) BUCKETS 8
PROPERTIES (
    "replication_num" = "3"
);
```

### 查看分桶分布

```sql
SHOW PARTITIONS FROM example_db.user_behavior;
```

返回结果示例：

```
+-------------+---------------+----------------+---------------------+--------------------+--------+--------------+--------------------------+---------------------+---------------------+-------------------------+----------+------------+------------------------+---------+
| PartitionId | PartitionName | VisibleVersion | VisibleVersionTime  | VisibleVersionHash | State  | PartitionKey | Range                   | DistributionKey     | Buckets             | ReplicationNum          | StorageMedium | CooldownTime | LastConsistencyCheckTime | DataSize |
+-------------+---------------+----------------+---------------------+--------------------+--------+--------------+--------------------------+---------------------+---------------------+-------------------------+----------+------------+------------------------+---------+
| 10001       | p202301       | 1              | 2023-01-01 00:00:00 | 0                  | NORMAL | ts           | [types: [DATETIME]; ... | user_id, item_id    | 8                   | 3                       | HDD      | NULL       | NULL                   | 0.000   |
| 10002       | p202302       | 1              | 2023-02-01 00:00:00 | 0                  | NORMAL | ts           | [types: [DATETIME]; ... | user_id, item_id    | 8                   | 3                       | HDD      | NULL       | NULL                   | 0.000   |
+-------------+---------------+----------------+---------------------+--------------------+--------+--------------+--------------------------+---------------------+---------------------+-------------------------+----------+------------+------------------------+---------+
```

### 查看Tablet分布

```sql
SHOW TABLETS FROM example_db.user_behavior;
```

返回结果示例(部分)：

```
+----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+------------+---------------------+--------------------------+---------------+
| TabletId | ReplicaId | BackendId | SchemaHash | Version | VersionHash | LstSuccessVersion | LstSuccessVersionHash | LstFailedVersion | LstFailedTime | LocalDataSize | RemoteDataSize | RowCount | State  |
+----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+------------+---------------------+--------------------------+---------------+
| 10003    | 10004     | 10005     | 123456     | 1       | 0           | 1                 | 0                     | -1               | NULL        | 0                   | 0                        | 0             | NORMAL |
| 10006    | 10007     | 10008     | 123456     | 1       | 0           | 1                 | 0                     | -1               | NULL        | 0                   | 0                        | 0             | NORMAL |
| ...      | ...       | ...       | ...        | ...     | ...         | ...               | ...                   | ...              | ...         | ...                 | ...                      | ...           | ...    |
+----------+-----------+-----------+------------+---------+-------------+-------------------+-----------------------+------------------+------------+---------------------+--------------------------+---------------+
```

## 6. 分桶与分区对比

```
+----------------------+--------------------------------+--------------------------------+
| 特性                | 分区(Partition)                | 分桶(Bucket)                  |
+----------------------+--------------------------------+--------------------------------+
| 目的                | 数据生命周期管理               | 数据水平切分和分布式计算       |
| 划分方式            | 按范围或列表                   | 哈希                          |
| 数据分布            | 不同分区存储不同范围数据       | 数据均匀分布                  |
| 查询优化            | 分区裁剪                      | 分桶裁剪                      |
| 数量建议            | 一般不超过100个                | 根据数据量和节点数动态调整    |
| 修改方式            | 可动态增删                     | 建表后不能修改                |
| 存储位置            | 不同分区可指定不同存储介质     | 所有分桶存储方式相同          |
+----------------------+--------------------------------+--------------------------------+
```

## 7. 分桶最佳实践

1. **避免数据倾斜**：选择分桶键时要确保数据能均匀分布
2. **合理设置分桶数**：考虑数据量和BE节点数
3. **查询优化**：WHERE条件尽量包含分桶键
4. **JOIN优化**：JOIN字段尽量包含分桶键，可避免数据shuffle

## 8. 分桶常见问题

### Q: 分桶数设置后可以修改吗？
```
A: 分桶数在表创建后不能直接修改，但可以通过以下方式间接实现：
1. 创建新表并指定新的分桶数
2. 使用`INSERT INTO new_table SELECT * FROM old_table`迁移数据
3. 通过`ALTER TABLE RENAME`交换表名
```
### Q: 如何判断分桶是否均匀？
```sql
-- 查看每个Tablet的数据量
SHOW TABLETS FROM example_db.user_behavior;
```

返回结果中查看`LocalDataSize`字段，各Tablet大小应该相近。