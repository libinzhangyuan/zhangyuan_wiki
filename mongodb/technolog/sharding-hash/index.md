# MongoDB 哈希分片详解

哈希分片是 MongoDB 中一种数据分布策略，它使用哈希算法将数据均匀分布到各个分片上。下面我将详细介绍哈希分片的原理、配置方法和使用场景。

## 哈希分片原理

哈希分片通过对分片键的值进行哈希计算，然后根据哈希值将数据分布到不同的分片上。这种方式可以确保数据均匀分布，即使分片键的值是连续的或相似的。

## 配置哈希分片步骤

### 1. 启用分片功能

首先确保 MongoDB 集群已配置为分片集群（包含配置服务器、路由服务器和分片服务器）。

### 2. 选择分片键并创建哈希索引

```javascript
// 对集合的某个字段创建哈希索引
db.collection.createIndex({ shardKeyField: "hashed" })
```

### 3. 启用集合的分片

```javascript
sh.shardCollection("database.collection", { shardKeyField: "hashed" })
```

## 哈希分片示例

### 示例1：基于用户ID的哈希分片

```javascript
// 创建哈希索引
db.users.createIndex({ userId: "hashed" })

// 启用分片
sh.shardCollection("mydb.users", { userId: "hashed" })
```

### 示例2：基于时间戳的哈希分片

```javascript
// 创建哈希索引
db.logs.createIndex({ timestamp: "hashed" })

// 启用分片
sh.shardCollection("mydb.logs", { timestamp: "hashed" })
```

## 哈希分片 vs 范围分片

```
| 特性                | 哈希分片                      | 范围分片                      |
|---------------------|-----------------------------|-----------------------------|
| 数据分布            | 均匀分布                    | 可能不均匀                  |
| 查询性能            | 点查询高效                  | 范围查询高效                |
| 适合场景            | 随机读写负载                | 有局部性的读写负载          |
| 分片键选择          | 任意值                      | 通常选择有序值              |
| 热点问题            | 较少出现                    | 可能出现                    |
```

## 哈希分片使用场景

1. **高随机读写负载**：当读写操作随机分布在数据集上时
2. **无自然有序键**：当没有明显的范围查询需求时
3. **均匀分布需求**：需要数据均匀分布在各个分片上时
4. **避免热点**：防止某些分片因数据局部性而过载

## 哈希分片注意事项

1. **不能使用多字段哈希分片**：MongoDB 只支持单字段的哈希分片
2. **浮点数处理**：哈希前会将浮点数转换为整数
3. **分片键不可变**：分片后不能更改分片键的值
4. **哈希冲突**：不同值可能产生相同的哈希值，但 MongoDB 会处理这种情况
5. **分片键大小限制**：哈希分片键必须小于512字节

## 哈希分片性能考虑

1. **写入性能**：哈希分片通常提供更好的写入扩展性
2. **查询性能**：对于精确匹配查询高效，但范围查询需要查询所有分片
3. **内存使用**：哈希计算需要额外CPU资源
4. **分片迁移**：数据分布均匀可以减少分片迁移的需求

## 监控哈希分片

```javascript
// 查看分片状态
sh.status()

// 查看数据分布情况
db.collection.getShardDistribution()

// 查看分片集群平衡状态
sh.isBalancerRunning()
```

## 哈希分片限制

1. 不能创建复合哈希索引（如 `{a:1, b:"hashed"}`）
2. 不能对已有数据的集合直接更改为哈希分片
3. 哈希分片不支持地理空间索引
4. 2.4版本前创建的哈希分片集群需要特殊处理

哈希分片是 MongoDB 中实现数据水平扩展的强大工具，特别适合需要均匀数据分布和高写入吞吐量的场景。正确选择分片键和分片策略对系统性能至关重要。