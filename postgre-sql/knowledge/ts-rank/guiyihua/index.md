[返回](/postgre-sql/knowledge/ts-rank/index)

# PostgreSQL 全文搜索归一化选项详解

在 PostgreSQL 的全文搜索排名函数 (`ts_rank` 和 `ts_rank_cd`) 中，归一化选项是一个非常重要的参数，它通过位掩码的方式控制如何调整排名分数，以消除文档长度等因素对排名结果的影响。

## 归一化选项概览

归一化选项是一个整数参数，通过不同的位组合来实现多种归一化效果。以下是可用的位掩码值及其含义：

```

| 位掩码值 | 描述 | 数学表达式 |
|---------|------|-----------|
| 0 (默认) | 不进行任何归一化 | rank |
| 1 | 除以 (文档长度 + 1) | rank / (length + 1) |
| 2 | 除以 (唯一词数量 + 1) | rank / (unique_words + 1) |
| 4 | 除以 (平均词频 + 1) | rank / (avg_lex_freq + 1) |
| 8 | 考虑匹配词的位置 | 调整基于词的位置 |
| 16 | 考虑匹配词之间的接近度 | 调整基于词的距离 |
| 32 | 除以 (最高权重 + 1) | rank / (max_weight + 1) |
```
## 组合使用归一化选项

可以通过将不同的位掩码值相加来组合多种归一化效果：

```sql
-- 单个选项
ts_rank(tsv, query, 1)  -- 仅除以文档长度
ts_rank(tsv, query, 2)  -- 仅除以唯一词数量

-- 组合选项
ts_rank(tsv, query, 3)  -- 1+2: 除以文档长度和唯一词数量
ts_rank(tsv, query, 5)  -- 1+4: 除以文档长度和平均词频
ts_rank(tsv, query, 7)  -- 1+2+4: 除以文档长度、唯一词数量和平均词频
ts_rank(tsv, query, 15) -- 1+2+4+8: 组合前四种归一化
```

## 详细解释每种归一化选项

### 1. 除以文档长度 (位掩码值: 1)

**作用**: 补偿长文档中词频自然较高的影响

**计算方式**:
```
调整后的排名 = 原始排名 / (文档总词数 + 1)
```

**适用场景**:
- 当不希望仅仅因为文档较长就获得更高排名时
- 平衡短文档和长文档的搜索结果

**示例**:
```sql
SELECT ts_rank(to_tsvector('short document'), to_tsquery('document'), 1);
SELECT ts_rank(to_tsvector('this is a much longer document with more words'), to_tsquery('document'), 1);
```

### 2. 除以唯一词数量 (位掩码值: 2)

**作用**: 补偿词汇多样性文档的影响

**计算方式**:
```
调整后的排名 = 原始排名 / (文档中唯一词的数量 + 1)
```

**适用场景**:
- 当文档包含大量不同词汇时
- 希望降低主题分散文档的排名

### 4. 除以平均词频 (位掩码值: 4)

**作用**: 补偿高频词的影响

**计算方式**:
```
调整后的排名 = 原始排名 / (平均每个词的出现次数 + 1)
```

**适用场景**:
- 当文档包含大量重复词汇时
- 希望降低关键词堆砌文档的排名

### 8. 考虑匹配词位置 (位掩码值: 8)

**作用**: 给予文档开头附近的匹配更高权重

**计算方式**:
- 根据匹配词在文档中的位置调整排名
- 文档开头的匹配比结尾的匹配权重更高

**适用场景**:
- 当文档开头内容更重要时(如新闻文章、学术论文)
- 标题和摘要比正文更重要的情况

### 16. 考虑匹配词接近度 (位掩码值: 16)

**作用**: 给予彼此接近的匹配词更高权重

**计算方式**:
- 计算匹配词之间的距离
- 距离越近的匹配权重越高

**适用场景**:
- 短语搜索或相关词搜索
- 当查询词的接近程度影响相关性时

### 32. 除以最高权重 (位掩码值: 32)

**作用**: 补偿高权重词的影响

**计算方式**:
```
调整后的排名 = 原始排名 / (最高权重值 + 1)
```

**适用场景**:
- 当使用了 `setweight()` 分配不同权重时
- 需要平衡不同权重部分的影响

## 实际应用示例

### 新闻搜索场景

```sql
-- 假设新闻文章有标题(权重A)和正文(权重B)
-- 我们希望:
-- 1. 补偿文档长度影响
-- 2. 考虑匹配词位置(标题更重要)
-- 3. 考虑词接近度
SELECT 
    headline,
    ts_rank_cd(
        tsv, 
        to_tsquery('breaking & news'),
        1 | 8 | 16  -- 1+8+16=25
    ) AS rank
FROM news_articles
WHERE tsv @@ to_tsquery('breaking & news')
ORDER BY rank DESC
LIMIT 10;
```

### 学术论文搜索

```sql
-- 对于学术论文，我们可能更关注:
-- 1. 唯一词数量(主题集中性)
-- 2. 匹配词位置(标题和摘要更重要)
-- 3. 最高权重(平衡各部分影响)
SELECT
    title,
    ts_rank(
        tsv,
        to_tsquery('quantum & computing'),
        2 | 8 | 32  -- 2+8+32=42
    ) AS rank
FROM research_papers
WHERE tsv @@ to_tsquery('quantum & computing')
ORDER BY rank DESC;
```

## 选择最佳归一化策略

选择哪种归一化组合取决于具体的应用场景和数据特征:

1. **通用场景**: 尝试 `3` (1+2) 或 `7` (1+2+4)
2. **标题很重要**: 加入 `8` (位置考虑)
3. **短语搜索**: 加入 `16` (接近度)
4. **多部分文档**: 加入 `32` (权重平衡)

可以通过实验不同组合，结合用户反馈来选择最适合的归一化策略。

记住，归一化会增加计算开销，所以对于大型文档集，需要在效果和性能之间找到平衡。