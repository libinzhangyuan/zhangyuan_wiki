

[返回](/postgre-sql/knowledge/index)

在PostgreSQL中，时间戳（Timestamp）是用于存储日期和时间信息的数据类型，主要分为两种：`timestamp`（不带时区）和`timestamptz`（带时区，全称`timestamp with time zone`）。两者的核心区别在于是否考虑时区转换。


### 1. 两种时间戳类型对比
```
| 类型         | 特点                                  | 存储方式                          | 适用场景                          |
|--------------|---------------------------------------|-----------------------------------|-----------------------------------|
| `timestamp`  | 不包含时区信息，仅存储日期和时间      | 直接存储输入的日期时间值          | 不需要考虑时区的本地时间记录      |
| `timestamptz`| 包含时区信息（内部以UTC存储）         | 自动转换为UTC时间后存储，查询时根据会话时区显示 | 需要跨时区同步的时间记录（如日志、全球事件） |
```

```
-- 查看两种类型的存储差异示例
-- 创建测试表
CREATE TABLE timestamp_demo (
  ts  timestamp,
  tstz timestamptz
);

-- 插入相同的时间字符串（带时区）
INSERT INTO timestamp_demo 
VALUES ('2023-10-01 12:00:00+08', '2023-10-01 12:00:00+08');

-- 查看存储结果（内部存储）
-- 注意：timestamptz会转换为UTC（+08时区的12:00对应UTC的04:00）
SELECT ts, tstz FROM timestamp_demo;
```

返回结果：
```
           ts            |           tstz            
-------------------------+---------------------------
 2023-10-01 12:00:00     | 2023-10-01 04:00:00+00   -- 转换为UTC存储
```


### 2. 时区对查询结果的影响
`timestamptz`查询时会根据当前会话的时区设置自动转换显示，而`timestamp`不受时区影响。

```
-- 查看当前会话时区
SHOW timezone;
```

返回结果：
```
 TimeZone 
----------
 UTC
```

```
-- 修改会话时区为上海（+08:00）
SET timezone = 'Asia/Shanghai';

-- 再次查询表中数据
SELECT ts, tstz FROM timestamp_demo;
```

返回结果：
```
           ts            |           tstz            
-------------------------+---------------------------
 2023-10-01 12:00:00     | 2023-10-01 12:00:00+08   -- 按上海时区显示
```

```
-- 修改会话时区为纽约（-04:00）
SET timezone = 'America/New_York';

-- 再次查询表中数据
SELECT ts, tstz FROM timestamp_demo;
```

返回结果：
```
           ts            |           tstz            
-------------------------+---------------------------
 2023-10-01 12:00:00     | 2023-10-01 00:00:00-04   -- 按纽约时区显示
```


### 3. 常用时间戳函数
#### （1）获取当前时间戳
```
-- 获取当前timestamp（不带时区）
SELECT current_timestamp::timestamp;

-- 获取当前timestamptz（带时区）
SELECT current_timestamp;  -- 等效于 now()
```

返回结果：
```
       current_timestamp        
-------------------------------
 2025-09-22 10:30:45.123456

              now              
-------------------------------
 2025-09-22 10:30:45.123456+00
```

#### （2）格式化时间戳
使用`to_char()`函数将时间戳转换为指定格式的字符串：
```
SELECT 
  to_char(now(), 'YYYY-MM-DD HH24:MI:SS') AS "年月日 时分秒",
  to_char(now(), 'Dy, Mon DD, YYYY') AS "英文格式";
```

返回结果：
```
 年月日 时分秒    |    英文格式    
-------------------+-----------------
 2025-09-22 10:35:22 | Mon, Sep 22, 2025
```

#### （3）提取时间戳部分
使用`extract()`或`date_part()`提取年、月、日等信息：
```
SELECT
  extract(year from now()) AS "年",
  extract(month from now()) AS "月",
  extract(day from now()) AS "日",
  extract(hour from now()) AS "时";
```

返回结果：
```
 年   | 月  | 日  | 时  
------+-----+-----+-----
 2025 | 9   | 22  | 10
```

#### （4）时间戳计算
对时间戳进行加减运算（支持`interval`类型）：
```
-- 当前时间加1小时
SELECT now() + interval '1 hour' AS "1小时后";

-- 当前时间减30分钟
SELECT now() - interval '30 minutes' AS "30分钟前";
```

返回结果：
```
          1小时后           
---------------------------
 2025-09-22 11:38:10.789012+00

          30分钟前           
---------------------------
 2025-09-22 10:08:10.789012+00
```


### 总结
- 若需处理跨时区业务，优先使用`timestamptz`，确保时间在不同时区下的一致性。
- 本地场景且无需时区转换时，可使用`timestamp`，更轻量。
- 利用`to_char()`、`extract()`等函数可灵活处理时间戳的格式化和计算。